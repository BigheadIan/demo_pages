# 金龍永盛 AI 客服系統 - 多輪對話測試案例

**測試日期**: 2025-12-20
**測試時間**: 00:31 (UTC+8)
**測試結果**: 12/12 通過

---

## 測試環境

- Node.js 環境
- Gemini 2.0 Flash 意圖分類器
- 本地記憶體 Session 模式

---

## 測試案例列表

### 測試 1: 訂票流程（TICKET_BOOK）

**目的**: 驗證完整的多輪對話資訊收集流程

| 步驟 | 用戶訊息 | 預期意圖 | 預期行為 |
|------|---------|---------|---------|
| 1 | 我想訂去東京的機票 | TICKET_BOOK | 詢問日期和人數 |
| 2 | 3/26 | TICKET_BOOK (延續) | 記錄日期，詢問人數 |
| 3 | 2位 | TICKET_BOOK (延續) | 顯示所有資訊，等待確認 |
| 4 | 確認 | TICKET_BOOK (延續) | 確認完成，轉人工處理 |

**驗證點**:
- [x] 意圖正確識別
- [x] 資訊逐步收集
- [x] 對話延續正常
- [x] 確認後轉人工

---

### 測試 2: 訂票完整資訊一次提供

**目的**: 驗證一次提供完整資訊時的處理

| 步驟 | 用戶訊息 | 預期意圖 | 預期行為 |
|------|---------|---------|---------|
| 1 | 我要訂3/26去東京的機票，2位大人 | TICKET_BOOK | 直接顯示所有資訊，等待確認 |
| 2 | 好 | TICKET_BOOK (延續) | 確認完成，轉人工處理 |

**驗證點**:
- [x] 一次提取多個實體
- [x] 跳過資訊收集步驟
- [x] 確認語識別正確

---

### 測試 3: 改票流程（TICKET_CHANGE）

**目的**: 驗證改票請求處理

| 步驟 | 用戶訊息 | 預期意圖 | 預期行為 |
|------|---------|---------|---------|
| 1 | 我要改機票 | TICKET_CHANGE | 提示改票費用，請求訂位代號 |
| 2 | 改成4/1，訂位代號 BTE2500208 | TICKET_CHANGE | 記錄資訊，轉人工處理 |

**驗證點**:
- [x] 改票意圖識別
- [x] 改票費用提示
- [x] 轉人工處理

---

### 測試 4: 報價查詢（QUOTE_REQUEST）

**目的**: 驗證報價查詢的多輪資訊收集

| 步驟 | 用戶訊息 | 預期意圖 | 預期行為 |
|------|---------|---------|---------|
| 1 | 去曼谷多少錢 | QUOTE_REQUEST | 詢問日期 |
| 2 | 下個月 | QUOTE_REQUEST (延續) | 繼續詢問日期（模糊日期無法識別） |
| 3 | 4個人 | QUOTE_REQUEST (延續) | 記錄人數，繼續詢問日期 |

**驗證點**:
- [x] 報價意圖識別
- [x] 目的地自動提取
- [x] 人數提取正確

---

### 測試 5: 退票請求（TICKET_CANCEL）

**目的**: 驗證退票請求直接轉人工

| 步驟 | 用戶訊息 | 預期意圖 | 預期行為 |
|------|---------|---------|---------|
| 1 | 我要退票 | TICKET_CANCEL | 提示退票注意事項，轉人工 |
| 2 | 訂位代號 BTE2500301 | TICKET_CANCEL | 繼續轉人工處理 |

**驗證點**:
- [x] 退票意圖識別
- [x] 退票費用提示
- [x] 直接轉人工（不需多輪對話）

---

### 測試 6: 簽證查詢（VISA_INQUIRY）

**目的**: 驗證簽證諮詢自動回覆

| 步驟 | 用戶訊息 | 預期意圖 | 預期行為 |
|------|---------|---------|---------|
| 1 | 去泰國需要簽證嗎 | VISA_INQUIRY | 自動回覆簽證資訊 |

**驗證點**:
- [x] 簽證意圖識別
- [x] 目的地提取
- [x] 自動回覆（不需轉人工）

---

### 測試 7: 座位選擇（SEAT_REQUEST）

**目的**: 驗證座位偏好記錄

| 步驟 | 用戶訊息 | 預期意圖 | 預期行為 |
|------|---------|---------|---------|
| 1 | 我想選靠窗的位子，訂位代號 BTE2500105 | SEAT_REQUEST | 記錄座位偏好 |

**驗證點**:
- [x] 座位意圖識別
- [x] 座位偏好提取（靠窗）
- [x] 訂位代號提取

---

### 測試 8: 意圖切換

**目的**: 驗證對話中途切換意圖再返回

| 步驟 | 用戶訊息 | 預期意圖 | 預期行為 |
|------|---------|---------|---------|
| 1 | 我要訂去大阪的機票 | TICKET_BOOK | 開始訂票流程 |
| 2 | 等等，去日本需要簽證嗎 | VISA_INQUIRY | 切換到簽證查詢 |
| 3 | 好的，那我要訂5/1去大阪，3位 | TICKET_BOOK | 返回訂票，收集完整資訊 |

**驗證點**:
- [x] 意圖切換正確
- [x] 新意圖獨立處理
- [x] 可返回原意圖

---

### 測試 9: 確認語變化

**目的**: 驗證各種確認語都能正確識別

| 確認語 | 預期結果 |
|--------|---------|
| 好 | ✅ 通過 |
| 好的 | ✅ 通過 |
| OK | ✅ 通過 |
| 可以 | ✅ 通過 |
| 對 | ✅ 通過 |
| 沒問題 | ✅ 通過 |
| 是的 | ✅ 通過 |
| 確認 | ✅ 通過 |
| 確定 | ✅ 通過 |
| 對的 | ✅ 通過 |

**驗證點**:
- [x] 10種確認語全部識別
- [x] 確認後正確完成訂票流程

---

### 測試 10: 付款請求（PAYMENT_REQUEST）

**目的**: 驗證付款請求處理

| 步驟 | 用戶訊息 | 預期意圖 | 預期行為 |
|------|---------|---------|---------|
| 1 | 我要付款，訂位代號 BTE2500199 | PAYMENT_REQUEST | 提供付款方式，轉人工 |

**驗證點**:
- [x] 付款意圖識別
- [x] 付款方式說明
- [x] 轉人工發送刷卡連結

---

### 測試 11: 轉人工（TRANSFER_AGENT）

**目的**: 驗證直接轉人工請求

| 步驟 | 用戶訊息 | 預期意圖 | 預期行為 |
|------|---------|---------|---------|
| 1 | 我要找真人客服 | TRANSFER_AGENT | 提供服務時間和緊急電話 |

**驗證點**:
- [x] 轉人工意圖識別
- [x] 服務時間說明
- [x] 緊急聯絡電話提供

---

### 測試 12: 短訊息延續

**目的**: 驗證數字、日期等短訊息能延續對話

| 步驟 | 用戶訊息 | 預期意圖 | 預期行為 |
|------|---------|---------|---------|
| 1 | 去香港多少 | QUOTE_REQUEST | 詢問日期 |
| 2 | 2 | QUOTE_REQUEST (延續) | 記錄人數 |
| 3 | 下週五 | QUOTE_REQUEST (延續) | 識別為日期資訊 |

**驗證點**:
- [x] 純數字訊息延續
- [x] 短日期訊息延續
- [x] 不重新分類為其他意圖

---

## 執行測試

```bash
cd /Users/BigheadIan/Desktop/travel\ agency/backend
node tests/multiTurnConversation.test.js
```

---

## 修改記錄

### 2025-12-20 修復項目

1. **確認語識別擴展** (`intentRouter.js:467`)
   - 原本: `/^(好|對|是|OK|可以|沒問題)$/`
   - 修改: `/^(好|好的|對|對的|是|是的|OK|可以|沒問題|嗯|沒錯|正確)$/`

2. **確認邏輯修復** (`intentRouter.js:470-495`)
   - 問題: `collectedInfo` 在 LINE 模式下為 null
   - 修復: 優先從 `entities` 取資料，再從 `collectedInfo` 取

---

## 已知限制

1. 模糊日期（如「下個月」「下週五」）無法轉換為具體日期
2. 改票/退票流程設計為直接轉人工，不進行多輪對話
3. FAQ 資料需要在伺服器啟動時載入

---

*文檔產生時間: 2025-12-20 00:35 (UTC+8)*
